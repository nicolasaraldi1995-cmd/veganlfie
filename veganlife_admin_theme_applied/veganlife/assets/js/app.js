let currentSlide=0; const autoSlide=()=>{const track=document.querySelector(".slide-track"); if(!track)return; const total=track.children.length; currentSlide=(currentSlide+1)%total; track.style.transform=`translateX(-${currentSlide*100}%)`;}; setInterval(autoSlide,4500);
const cartDrawer={el:null,open(){this.el=this.el||document.querySelector("#cartDrawer"); if(this.el)this.el.classList.add("open");},close(){this.el=this.el||document.querySelector("#cartDrawer"); if(this.el)this.el.classList.remove("open");},async refresh(){const r=await fetch("/cart/cart_sidebar.php"); const html=await r.text(); const target=document.querySelector("#cartItems"); if(target){target.innerHTML=html;}}};
const filters={search:"",cat:"",brand:"",st:{st:0,cong:0,veg:0},init(){const s=document.querySelector("#searchInput"); if(s){s.addEventListener("input",(e)=>{this.search=e.target.value; this.load();});} document.querySelectorAll("[data-chip-cat]").forEach(chip=>{chip.addEventListener("click",()=>{const v=chip.getAttribute("data-chip-cat"); this.cat=(this.cat===v)?"":v; document.querySelectorAll("[data-chip-cat]").forEach(c=>c.classList.remove("active")); if(this.cat)chip.classList.add("active"); this.load();});}); document.querySelectorAll("[data-chip-brand]").forEach(chip=>{chip.addEventListener("click",()=>{const v=chip.getAttribute("data-chip-brand"); this.brand=(this.brand===v)?"":v; document.querySelectorAll("[data-chip-brand]").forEach(c=>c.classList.remove("active")); if(this.brand)chip.classList.add("active"); this.load();});}); const stacc=document.querySelector("#f_st"); const cong=document.querySelector("#f_cong"); const veg=document.querySelector("#f_veg"); [stacc,cong,veg].forEach(el=>{if(!el)return; el.addEventListener("change",()=>{this.st.st=stacc.checked?1:0; this.st.cong=cong.checked?1:0; this.st.veg=veg.checked?1:0; this.load();});}); this.load();},async load(){const p=new URLSearchParams(); if(this.search)p.set("q",this.search); if(this.cat)p.set("cat",this.cat); if(this.brand)p.set("brand",this.brand); if(this.st.st)p.set("sin_tacc","1"); if(this.st.cong)p.set("congelado","1"); if(this.st.veg)p.set("veganlife","1"); const r=await fetch("/ajax/products.php?"+p.toString()); const html=await r.text(); const grid=document.querySelector("#gridProducts"); if(grid)grid.innerHTML=html;}};
document.addEventListener("DOMContentLoaded",()=>{filters.init(); cartDrawer.refresh();});
document.addEventListener("click",async(e)=>{const add=e.target.closest("[data-add]"); if(add){e.preventDefault(); const id=add.getAttribute("data-add"); await fetch("/cart/add_to_cart.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({id,qty:1})}); await cartDrawer.refresh(); cartDrawer.open();}});
document.addEventListener("input",async(e)=>{const qty=e.target.closest("[data-qty-id]"); if(qty){const id=qty.getAttribute("data-qty-id"); const val=e.target.value; await fetch("/cart/update_cart.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({id,qty:val})}); await cartDrawer.refresh();}});
document.addEventListener("click",async(e)=>{const del=e.target.closest("[data-del-id]"); if(del){const id=del.getAttribute("data-del-id"); await fetch("/cart/remove_from_cart.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({id})}); await cartDrawer.refresh();}});
document.addEventListener("click",async(e)=>{const ck=e.target.closest("#checkoutBtn"); if(ck){const r=await fetch("/cart/checkout.php",{method:"POST"}); const j=await r.json(); if(j.ok){alert("Pedido confirmado #"+j.pedido_id); cartDrawer.close(); await cartDrawer.refresh();}else{alert("No se pudo confirmar el pedido");}}});
